<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <title>Сервис-ориентированная архитектура, лабораторная работа #1</title>
    <link rel="shortcut icon" href="img/favicon.ico">

    <link rel="stylesheet" type="text/css" href="css/base.css">
    <link rel="stylesheet" type="text/css" href="css/base-platform-dependent.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" type="text/css" href="css/main-platform-dependent.css">
    <link rel="stylesheet" type="text/css" href="css/thirdparty/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/thirdparty/bootstrap-table.min.css">
</head>

<body>
<div id="app" class="pl-5 pr-5">
    <filters v-on:filter="filter"></filters>
    <result-table v-bind:movies="movies" v-on:deletemovie="deleteMovie" v-on:editmovie="editMovie"></result-table>
    <add-movie v-on:addmovie="addMovie" v-bind:personsList="personsList"
               v-bind:coordinatesList="coordinatesList" ref="mainform"></add-movie>
</div>

<script src="https://unpkg.com/vue"></script>
<script src="https://unpkg.com/vue-resource"></script>
<script src="js/basic-components.js"></script>
<script src="js/main-components.js"></script>
<script src="https://momentjs.com/downloads/moment-with-locales.min.js"></script>

<script>
    var app = new Vue({
        el: '#app',
        data: {
            movies: [],
            coordinatesList: [],
            personsList: []
        },
        methods: {
            filter: function(filterInfo) {
                let params = []

                if (filterInfo.elementsCount) {
                    params.push('count=' + filterInfo.elementsCount)

                    if (filterInfo.pageNumber) {
                        params.push('page=' + filterInfo.pageNumber)
                    }
                }

                if (filterInfo.orderBy !== 'none' && filterInfo.orderDirection) {
                    params.push('order=' + filterInfo.orderBy + ',' + filterInfo.orderDirection)
                }

                if (filterInfo.filterById) {
                    params.push('filter=id,==,' + filterInfo.filterById)
                }
                if (filterInfo.filterByName) {
                    params.push('filter=name,contains,' + filterInfo.filterByName)
                }
                if (filterInfo.filterByCoordinates) {
                    params.push('filter=coordinates,==,' + filterInfo.filterByCoordinates)
                }
                if (filterInfo.filterByCreationDate && filterInfo.filterByCreationDateAction) {
                    params.push('filter=creationDate,' + filterInfo.filterByCreationDateAction + ',' + filterInfo.filterByCreationDate)
                }
                if (filterInfo.filterByOscarCount && filterInfo.filterByOscarCountAction) {
                    params.push('filter=oscarsCount,' + filterInfo.filterByOscarCountAction + ',' + filterInfo.filterByOscarCount)
                }
                if (filterInfo.filterByGoldenPalmCount && filterInfo.filterByGoldenPalmCountAction) {
                    params.push('filter=goldenPalmCount,' + filterInfo.filterByGoldenPalmCountAction + ',' + filterInfo.filterByGoldenPalmCount)
                }
                if (filterInfo.filterByTotalBoxOffice && filterInfo.filterByTotalBoxOfficeAction) {
                    params.push('filter=totalBoxOffice,' + filterInfo.filterByTotalBoxOfficeAction + ',' + filterInfo.filterByTotalBoxOffice)
                }
                if (filterInfo.filterByRating) {
                    params.push('filter=mpaaRating,==,' + filterInfo.filterByRating)
                }
                if (filterInfo.filterByScreenWriter) {
                    params.push('filter=screenWriter,==,' + filterInfo.filterByScreenWriter)
                }

                params = params.join('&')

                this.$http.get(
                    'http://localhost:8080/SOA_Lab1_war/api/movie?' + params
                ).then(
                    (response) => {
                        this.movies = response.body;
                    },
                    (error) => {
                        if (error.status == 403 || error.status == 0) {
                        }
                    }
                );
            },
            deleteMovie: function (movie) {
                this.$http.delete(
                    'http://localhost:8080/SOA_Lab1_war/api/movie/id=' + movie.id
                ).then(
                    (response) => {
                        this.movies.splice(this.movies.indexOf(movie), 1);
                    },
                    (error) => {
                        if (error.status == 403 || error.status == 0) {
                        }
                    }
                );
            },
            addMovie: function (movie) {
                if (movie.id) {
                    this.$http.put(
                        'http://localhost:8080/SOA_Lab1_war/api/movie',
                        movie
                    ).then(
                        (response) => {
                            for (let i in this.movies) {
                                if (movie.id === this.movies[i].id) {
                                    this.movies.splice(i, 1);
                                    break
                                }
                            }
                            this.movies.push(response.body);
                        },
                        (error) => {
                            if (error.status == 403 || error.status == 0) {
                            }
                        }
                    );
                } else {
                    this.$http.post(
                        'http://localhost:8080/SOA_Lab1_war/api/movie',
                        movie
                    ).then(
                        (response) => {
                            this.movies.push(response.body);
                        },
                        (error) => {
                            if (error.status == 403 || error.status == 0) {
                            }
                        }
                    );
                }
            },
            editMovie: function (movie) {
                console.log(movie)
                this.$refs.mainform.$el.scrollIntoView({ behavior: 'smooth' });
                this.$refs.mainform.updateFields(movie);
            }
        },
        created: function() {
            this.$http.get(
                'http://localhost:8080/SOA_Lab1_war/api/movie',
                {
                }
            ).then(
                (response) => {
                    this.movies = response.body;
                },
                (error) => {
                    if (error.status == 403 || error.status == 0) {
                    }
                }
            );

            this.$http.get(
                'http://localhost:8080/SOA_Lab1_war/api/coordinates',
                {
                }
            ).then(
                (response) => {
                    this.coordinatesList = response.body;
                },
                (error) => {
                    if (error.status == 403 || error.status == 0) {
                    }
                }
            );

            this.$http.get(
                'http://localhost:8080/SOA_Lab1_war/api/person',
                {
                }
            ).then(
                (response) => {
                    this.personsList = response.body;
                },
                (error) => {
                    if (error.status == 403 || error.status == 0) {
                    }
                }
            );
        }
    })
</script>
</body>

</html>